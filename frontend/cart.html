<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart | Grocery Delivery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .cart-card { margin-bottom: 15px; }
        .cart-card img { height: 80px; width: 80px; object-fit: cover; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light px-3">
        <a class="navbar-brand" href="home.html">Grocery Delivery</a>
        <div class="ms-auto">
            <button class="btn btn-outline-primary me-2" onclick="window.location.href='home.html'">Home</button>
            <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container mt-4">
        <h3>Your Cart</h3>
        <div id="cartContainer"></div>
    </div>

    <script>
        const access = localStorage.getItem("access");
        if (!access) {
            alert("Please login first!");
            window.location.href = "login.html";
        }

        async function loadCart() {
            const container = document.getElementById("cartContainer");
            try {
                const res = await fetch("http://127.0.0.1:8000/api/cart/", {
                    headers: { "Authorization": "Bearer " + access }
                });
                const data = await res.json();
                container.innerHTML = "";

                if (data.length === 0) {
                    container.innerHTML = "<p>Your cart is empty.</p>";
                    return;
                }

                data.forEach(item => {
                    const product = item.product;
                    container.innerHTML += `
                        <div class="card cart-card p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5>${product.name}</h5>
                                    <p>Quantity: <span id="qty-${item.id}">${item.quantity}</span>${product.unit_name}</p>
                                    <p>total :â‚¹${item.quantity* product.price} |</p>

                                    <button class="btn btn-sm btn-success me-1" onclick="updateQuantity(${item.id}, 1)">+</button>
                                    <button class="btn btn-sm btn-warning me-1" onclick="updateQuantity(${item.id}, -1)">-</button>
                                    <button class="btn btn-sm btn-danger" onclick="removeItem(${item.id})">Remove</button>
                                    <div class="d-flex justify-content-end mt-3">
                                    <button class="btn btn-success btn-lg" onclick="placeOrder()">
                                     Place Order ðŸ›’
                                   </button>
                                </div>
                                </div>
                                <img src="${product.image}">
                            </div>
                        </div>
                    `;
                });
            } catch (err) {
                console.error(err);
                container.innerHTML = "Error loading cart.";
            }
        }

        async function updateQuantity(cartId, delta) {
            try {
                const currentQty = parseInt(document.getElementById(`qty-${cartId}`).innerText);
                const newQty = currentQty + delta;
                if (newQty < 1) return;

                const res = await fetch(`http://127.0.0.1:8000/api/cart/${cartId}/`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + access
                    },
                    body: JSON.stringify({ quantity: newQty })
                });

                if (!res.ok) {
                    const data = await res.json();
                    alert(data.detail || "Failed to update quantity");
                    return;
                }

                document.getElementById(`qty-${cartId}`).innerText = newQty;
            } catch (err) {
                console.error(err);
                alert("Error updating quantity");
            }
        }

        async function removeItem(cartId) {
            if (!confirm("Remove this item from cart?")) return;

            try {
                const res = await fetch(`http://127.0.0.1:8000/api/cart/${cartId}/`, {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + access }
                });

                if (!res.ok) {
                    const data = await res.json();
                    alert(data.detail || "Failed to remove item");
                    return;
                }

                alert("Item removed!");
                loadCart(); // refresh cart
            } catch (err) {
                console.error(err);
                alert("Error removing item");
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = "login.html";
        }

        // Load cart on page load
        document.addEventListener("DOMContentLoaded", loadCart);

        function placeOrder() {
    const access = localStorage.getItem("access");
    if (!access) {
        alert("Please login first!");
        window.location.href = "login.html";
        return;
    }

    // You can either redirect to a checkout page
    window.location.href = "checkout.html";

    // Or if you have an API endpoint to place an order directly:
    /*
    fetch("http://127.0.0.1:8000/api/orders/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + access
        },
        body: JSON.stringify({ /* send cart info or user id * / })
    })
    .then(res => res.json())
    .then(data => {
        alert("Order placed successfully!");
        window.location.href = "home.html";
    })
    .catch(err => {
        console.error(err);
        alert("Failed to place order");
    });
    */
}
    </script>
</body>
</html>